name: Build and Release BSP Static Library

on:
  push:
    branches: [ '**' ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  actions: read
  pull-requests: write
  checks: write

env:
  BUILD_TYPE: Debug

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/kodezine/kdocker:latest
    strategy:
      fail-fast: false
      matrix:
        preset: [
          "bsp-test-host",
          "bsp-gnuarm14.3",
          "bsp-atfe21.1"
        ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fix git safe directory
      run: |
        git config --global --add safe.directory /__w/bsp/bsp

    - name: Configure CMake
      run: |
        cmake --preset ${{ matrix.preset }}

    - name: Build
      run: |
        cmake --build --preset ${{ matrix.preset }} --config $BUILD_TYPE

    - name: Run Tests
      if: matrix.preset == 'bsp-test-host'
      run: |
        cmake --build --preset ${{ matrix.preset }} --target test

    - name: Generate Coverage Report
      if: matrix.preset == 'bsp-test-host'
      working-directory: build/bsp-test-host
      run: |
        # Create coverage directory
        mkdir -p coverage

        # Generate coverage reports using gcovr.cfg configuration
        gcovr -r ../../ . \
          --config ../../gcovr.cfg \
          --cobertura coverage/cobertura.xml \
          --html-details coverage/index.html \
          --txt coverage/summary.txt \
          --print-summary

    - name: Display Coverage Summary in Actions
      if: matrix.preset == 'bsp-test-host'
      working-directory: build/bsp-test-host
      run: |
        echo "## ðŸ“Š Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat coverage/summary.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Minimum Required Coverage:** 90%" >> $GITHUB_STEP_SUMMARY

    - name: Extract Coverage Percentage for Badge
      if: matrix.preset == 'bsp-test-host'
      id: coverage
      working-directory: build/bsp-test-host
      run: |
        # Extract line coverage percentage from summary
        COVERAGE=$(grep -oP 'lines: \K[0-9.]+' coverage/summary.txt | head -1)
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

        # Determine badge color based on coverage
        if (( $(echo "$COVERAGE >= 95" | bc -l) )); then
          COLOR="brightgreen"
        elif (( $(echo "$COVERAGE >= 90" | bc -l) )); then
          COLOR="green"
        elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          COLOR="yellow"
        elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
          COLOR="orange"
        else
          COLOR="red"
        fi
        echo "color=$COLOR" >> $GITHUB_OUTPUT

        # Create badge JSON for gist
        mkdir -p badge
        cat > badge/coverage.json << EOF
        {
          "schemaVersion": 1,
          "label": "coverage",
          "message": "${COVERAGE}%",
          "color": "$COLOR"
        }
        EOF

        echo "Coverage: ${COVERAGE}% (Color: $COLOR)"

    - name: Cobertura Coverage Report
      if: matrix.preset == 'bsp-test-host'
      uses: 5monkeys/cobertura-action@master
      with:
        path: build/bsp-test-host/coverage/cobertura.xml
        minimum_coverage: 90
        fail_below_threshold: true
        show_line: true
        show_branch: true
        show_missing: true
        skip_covered: false

    - name: Code Coverage Report
      if: matrix.preset == 'bsp-test-host'
      uses: irongut/CodeCoverageSummary@v1.3.0
      with:
        filename: build/bsp-test-host/coverage/cobertura.xml
        badge: true
        fail_below_min: true
        format: markdown
        hide_branch_rate: false
        hide_complexity: true
        indicators: true
        output: both
        thresholds: '90 95'

    - name: Add Coverage PR Comment
      if: matrix.preset == 'bsp-test-host' && github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        recreate: true
        path: code-coverage-results.md

    - name: Update Coverage Badge Gist
      if: matrix.preset == 'bsp-test-host' && (github.ref == 'refs/heads/main' || github.event_name == 'push')
      uses: exuanbo/actions-deploy-gist@v1
      with:
        token: ${{ secrets.GIST_TOKEN }}
        gist_id: ${{ secrets.COVERAGE_GIST_ID }}
        file_path: build/bsp-test-host/badge/coverage.json
        file_type: text

    - name: Upload Coverage Reports
      if: matrix.preset == 'bsp-test-host'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          build/bsp-test-host/coverage/

    - name: Upload Build Artifacts
      if: matrix.preset != 'bsp-test-host'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.preset }}-packages
        path: |
          build/${{ matrix.preset }}/*.tar.gz

  release:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Prepare release assets
      run: |
        # Create release directory and copy CPack generated packages
        mkdir -p release-assets

        # Debug: List all downloaded artifacts
        echo "Downloaded artifacts structure:"
        find artifacts/ -type f -name "*" | head -20

        # Copy all tar.gz files from artifacts
        find artifacts/ -name "*.tar.gz" -exec cp {} release-assets/ \;

        # Debug: List prepared release assets
        echo "Release assets prepared:"
        ls -la release-assets/

        # Ensure we have files to release
        if [ ! "$(ls -A release-assets/)" ]; then
          echo "Error: No release assets found!"
          exit 1
        fi

        # Generate SHA256 checksums for each file
        cd release-assets
        for file in *.tar.gz; do
          if [ -f "$file" ]; then
            sha256sum "$file" > "$file.sha256"
            echo "Generated: $file.sha256"
          fi
        done

        # Also create a combined SHA256SUMS.txt for convenience
        sha256sum *.tar.gz > SHA256SUMS.txt
        echo "SHA256 checksums generated:"
        cat SHA256SUMS.txt

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF_NAME#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        cat > RELEASE_NOTES.md << EOF
        # BSP Static Library Release ${{ steps.get_version.outputs.tag_name }}

        ## What's Included

        This release contains pre-built Board Support Package (BSP) static library:

        - **libbsp.a**: BSP library with board abstraction layer
        - **Multiple Toolchains**: Built with ARM GCC 14.3 and ARM Compiler for Embedded 21.1
        - **Debug Build with Symbols**: Compiled with debug information

        Each archive contains:
        - BSP static library (\`libbsp.a\`)
        - Complete BSP headers for Common modules:
          - BspAdc, BspAtFlash, BspButton, BspCan
          - BspEeprom, BspFuelGauge, BspGpio, BspI2c
          - BspLed, BspLedBar, BspPwm, BspRtc
          - BspSpi, BspWatchdog, CmdProc, SelfTest
          - BringUp utilities
        - CMake configuration files for easy integration
        - License information

        ## Build Configuration

        - **Build Type**: Debug (with debug symbols)
        - **Toolchains**:
          - ARM GCC 14.3 (arm-none-eabi-gcc)
          - ARM Compiler for Embedded 21.1 (armclang)
        - **CMake Version**: 3.28+
        - **Dependencies**: Requires CPB HAL library (libcpb.a)
        - **Target**: STM32F4 series (Cortex-M4F)

        ## Quick Start

        \`\`\`cmake
        find_package(bsp REQUIRED)
        target_link_libraries(your_target PRIVATE bsp::common)
        \`\`\`

        See USAGE.md in the package for detailed integration instructions.

        ## SHA256 Checksums

        \`\`\`
        EOF

        # Add checksums to release notes
        cat release-assets/SHA256SUMS.txt >> RELEASE_NOTES.md
        echo "\`\`\`" >> RELEASE_NOTES.md

    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: BSP Static Library ${{ steps.get_version.outputs.tag_name }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.tag_name, '-') }}
        files: |
          release-assets/*.tar.gz
          release-assets/*.sha256
          release-assets/SHA256SUMS.txt
        fail_on_unmatched_files: true
        make_latest: true
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
